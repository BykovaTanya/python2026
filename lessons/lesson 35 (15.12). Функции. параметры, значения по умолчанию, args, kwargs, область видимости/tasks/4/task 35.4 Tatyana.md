# Практическое задание 35.4

## Задания

### Описание задачи
В предыдущих блоках ты научилась создавать функции, передавать аргументы разными способами и использовать `*args` и `**kwargs`. Теперь важно закрепить понимание **области видимости переменных** — где и какую переменную можно использовать или изменить. Это предотвращает ошибки, когда код ведёт себя неожиданно из-за "невидимости" переменных.

Твоя задача — проанализировать готовую программу, которая управляет учётом книг в небольшой библиотеке, и исправить в ней ошибки, связанные с областью видимости. Программа состоит из нескольких функций, которые должны работать с общим списком книг и глобальным счётчиком операций. Некоторые функции написаны с ошибками: они пытаются изменить глобальные переменные, не объявив их, или создают путаницу между локальными и глобальными именами.

Ты должна:
1.  Прочитать код и найти все места, где происходит обращение к переменным вне текущей области видимости без правильного объявления (например, попытка изменить глобальную переменную без `global`).
2.  Исправить эти ошибки, добавив необходимые объявления (`global`) или изменив логику, чтобы избежать изменения глобального состояния там, где это не требуется.
3.  Убедиться, что итоговый код работает корректно: книги добавляются в общий список, счётчик операций увеличивается при каждом добавлении, а функция-генератор правильно создаёт замыкание для фильтрации книг по жанру.

### Пример входных и выходных данных

**Исходный код с ошибками:**
```python
library_books = []
operation_counter = 0

def add_book(title, author, genre):
    """Добавляет книгу в библиотеку и увеличивает счётчик."""
    new_book = {"title": title, "author": author, "genre": genre}
    library_books.append(new_book)
    operation_counter += 1  # ОШИБКА 1: попытка изменить глобальную переменную без объявления
    print(f"Книга '{title}' добавлена.")

def get_books_by_genre(target_genre):
    """Возвращает список книг заданного жанра."""
    filtered_books = []
    for book in library_books:
        if book["genre"] == target_genre:
            filtered_books.append(book)
    return filtered_books

def make_genre_filter(genre):
    """Создаёт и возвращает функцию для фильтрации книг по жанру."""
    def filter_function(book_list):
        result = []
        for book in book_list:
            if book["genre"] == genre:  # ОШИБКА 2: 'genre' берётся из внешней области — это не ошибка, это замыкание! Это правильно.
                result.append(book)
        return result
    return filter_function

# Основной сценарий
add_book("Мастер и Маргарита", "Булгаков", "роман")
add_book("Преступление и наказание", "Достоевский", "роман")
add_book("Записки о Шерлоке Холмсе", "Дойл", "детектив")

print(f"Всего операций: {operation_counter}")  # ОШИБКА 3: ожидается 3, но выведет 0, так как operation_counter не менялась.
print(f"Все книги: {library_books}")

filter_roman = make_genre_filter("роман")
roman_books = filter_roman(library_books)
print(f"Романы: {roman_books}")
```

**Ожидаемый вывод после исправления ошибок:**
```
Книга 'Мастер и Маргарита' добавлена.
Книга 'Преступление и наказание' добавлена.
Книга 'Записки о Шерлоке Холмсе' добавлена.
Всего операций: 3
Все книги: [{'title': 'Мастер и Маргарита', 'author': 'Булгаков', 'genre': 'роман'}, {'title': 'Преступление и наказание', 'author': 'Достоевский', 'genre': 'роман'}, {'title': 'Записки о Шерлоке Холмсе', 'author': 'Дойл', 'genre': 'детектив'}]
Романы: [{'title': 'Мастер и Маргарита', 'author': 'Булгаков', 'genre': 'роман'}, {'title': 'Преступление и наказание', 'author': 'Достоевский', 'genre': 'роман'}]
```

**Пояснение к примерам:**
*   В исходном коде `operation_counter` внутри функции `add_book` считается локальной переменной, так как ей присваивается значение. Поэтому глобальная `operation_counter` остаётся равной 0.
*   В функции `make_genre_filter` используется переменная `genre` из внешней функции — это пример корректного **замыкания**, ошибкой не является.
*   После исправления с помощью `global` счётчик должен увеличиваться при каждом вызове `add_book`.

### Критерии проверки и ограничения
*   **Исправлены все ошибки области видимости:** В функции `add_book` должно быть корректное объявление для изменения глобальной переменной `operation_counter`.
*   **Сохранена работоспособность замыкания:** Внутренняя функция `filter_function` должна по-прежнему использовать параметр `genre` внешней функции `make_genre_filter`.
*   **Глобальные переменные используются осознанно:** Изменение глобального списка `library_books` из функции `add_book` допустимо, так как это явная цель функции. Не следует без необходимости добавлять `global` для `library_books`, если ты только читаешь её значение (как в `get_books_by_genre`).
*   **Корректный итоговый вывод:** После выполнения исправленного кода вывод в консоль должен полностью совпадать с "Ожидаемым выводом".
*   **Запрещённые темы:** Не используй конструкции, не изученные в Block 4 (`область видимости, локальная переменная, глобальная переменная, global, замыкание, интеграция`). Не требуется создавать классы, декораторы или использовать модули.

### Решение задачи (псевдокод)
1.  Проанализировать функцию `add_book`:
    *   Определить, к каким переменным происходит обращение (`library_books`, `operation_counter`).
    *   Установить, что `library_books` только читается (вызывается метод `.append`) — это изменение самого объекта, а не переприсваивание переменной, поэтому `global` не требуется.
    *   Установить, что для `operation_counter` выполняется операция `+=`, которая подразумевает чтение и переприсваивание. Это создаст локальную переменную, если не объявить `global`.
    *   Добавить в начало функции строку, объявляющую `operation_counter` как глобальную переменную.
2.  Проанализировать функцию `make_genre_filter`:
    *   Проверить, как используется параметр `genre` во внутренней функции `filter_function`.
    *   Убедиться, что это корректный пример замыкания: внутренняя функция "запоминает" значение `genre` из внешней области видимости на момент создания. Никаких исправлений здесь не нужно.
3.  Проверить остальные функции (`get_books_by_genre`) на чтение глобальных переменных. Изменений не требуется.
4.  Запустить исправленный код и сверить вывод с ожидаемым.

### Рекомендации
*   Вынести в отдельную функцию: В данном задании выносить что-либо в отдельную функцию не требуется. Твоя цель — отладить и понять готовую структуру.
*   PEP8:
    *   Всегда ставь пробелы вокруг операторов присваивания (`=`, `+=`) и после запятых в списках аргументов и элементов коллекций для лучшей читаемости.
    *   Имена функций должны быть в `snake_case` и отражать действие (глагол), например, `add_book`, `get_books_by_genre`. Имена переменных также в `snake_case` и должны быть существительными, отражающими суть данных.
